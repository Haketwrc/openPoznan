---
title: "Vignette Graves"
author: "Konrad Jadwiżyc"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(tidyverse)
library(ggplot2)
library(plotly)
library(stats)
library(lubridate)


graves <- readRDS("../data/graves.rds")
```

# Date of birth analysis

```{r}
library(ggplot2)
library(plotly)
library(stats)

date_birth_n <- graves %>%
  group_by(g_date_birth) %>%
  count()

date_birth_n %>%
  arrange(desc(n)) %>%
  head(n=10)

```

Pierwszy i drugi wiersz to ewidentnie braki danych. Potem widać także, że jak znany był tylko rok to przypisywali 1-stycznia. W związku z tym sensownie będzie zamienić tę kolumnę na datę i wyodrębnić tylko rok. Przedstaw na wykresie jak kształtowała się liczba grobów w zależności od roku urodzenia.

To samo zrób dla daty śmierci i pogrzebu.

Sprawdź dla ilu grobów kompletna jest data urodzenia i śmierci/śmierci i pogrzebu/urodzenia, śmierci i pogrzebu.

# Counts at cementaries

```{r, fig.height=7}
cementy <- openPoznan::cemeteries(coords = F)

graves_name <- left_join(graves, cementy, by=c("cm_id"="ID"))

ggplot(graves_name, aes(as.factor(Cemetery_Name))) + 
  geom_bar(aes(y = (..count..)/sum(..count..))) +
    geom_text(aes(label = scales::percent((..count..)/sum(..count..)),
                   y= (..count..)/sum(..count..)), size=3, stat= "count", vjust = -.5) +
  xlab("Cementary name") + 
  ylab("Percent") + 
  scale_y_continuous(labels=scales::percent) +
  theme_bw()+
  coord_flip()
```

Sprawdz jak wygląda częstość zmiennej paid i g_size.



```{r}

grave_size <- graves %>%
  group_by(paid,g_size) %>%
  count() %>%
  filter(g_size != "", !is.na(g_size))

ggplot(grave_size, aes(x=as.numeric(g_size), y=n)) + 
  geom_col() +
  facet_wrap(~ paid) +
  xlab("Grave size") +
  ylab("number")

```


Przedstawienie jak wygląda płatność to rozmiaru grobu jako no_paid_graves groby nie opłacone 
paid_graves groby opłacone unknown wartość paid wynosi 0 więc mogą to być realizacje czekające na zapłatę albo nieznana wartość


```{r}
# oczyszczanie danych z błędnych danych 


data <- graves %>% na.omit(graves) %>% 
  select(g_date_birth) %>% 
  arrange(g_date_birth) %>%
  count(g_date_birth) %>% 
  slice(3:36788)

data2 <- graves %>% na.omit(graves) %>%
  select(g_date_death) %>% 
  count(g_date_death) %>% arrange(g_date_death) %>% slice(5:23907)

plot_ly(data = data2, x = ~g_date_death, y = ~n)


data3 <- graves %>% na.omit(graves) %>% 
  select(g_date_burial) %>% 
  arrange(g_date_burial) %>% count(g_date_burial) %>% slice(2:21207) 


plot_ly(data = data3, x = ~g_date_burial, y = ~n)

# analiza szeregów czasowych 




```

Podzeliłem dane na grupy daty urodzenia, daty śmierci i daty pochówku 
po oczyszczeniu danych zostały jeszcze daty typu 1900-01-01, 1800-01-01...itp które też powinny być usunięte 
potem można podzielić daty co 10 lat i badać zmiany w latach 


```{r}

graves_birth <- graves %>%
  filter(g_date_birth != "0001-01-01", 1) %>%
  mutate(g_date_birth=ymd(g_date_birth), # zamiana na datę w formacie ymd z pakietu lubridate
         g_year_birth=year(g_date_birth)) # wydobycie roku

graves_birth_count <- graves_birth %>%
  group_by(g_year_birth) %>%
  count()

# w roku urodzenia wystęuje wartość 1 aż 16 razy - po sprawdzeniu zbioru graves_birth okazuje się, że jedna osoba występuje tam 16 razy - czyli w zbiorze występują duplikaty

graves_birth_distinct <- graves_birth %>%
  distinct()

graves_birth_count_distinct <- graves_birth_distinct %>%
  group_by(g_year_birth) %>%
  count()

# usuwamy nieprawidłowe wartości

graves_birth_distinct <- graves_birth_distinct %>%
  filter(g_year_birth %in% c(1000:2018)) # lata urodzenia w przedziale od 1000 do 2018

ggplot(graves_birth_distinct, aes(g_year_birth)) +
  geom_bar()

```


```{r}
ggplot(graves_birth_distinct, aes(g_year_birth)) +
  geom_bar() +
  xlim(1850,2018)

```

```{r}
# usunięcie daty 1900-01-01, która też jest brakiem danych

graves_birth_distinct %>% na.omit(graves_birth_distinct) %>%
  filter(g_date_birth != "1900-01-01") %>%
  ggplot(aes(g_year_birth)) +
  geom_bar() +
  xlim(1850,2018)
```

```{r}
# pojedyncze roczniki

graves_birth_distinct %>% na.omit(graves_birth_distinct) %>%
  filter(g_date_birth != "1900-01-01") %>%
  ggplot(aes(g_year_birth)) +
  geom_histogram(binwidth = 1) +
  xlim(1850,2018)
```


```{r}
graves_death <- graves %>% 
  filter(g_date_death != "0001-01-01", 1) %>% 
  mutate(g_date_death=ymd(g_date_death),
  g_year_death=year(g_date_death))

graves_death_counr <- graves_death %>% 
  group_by(g_year_death) %>%
  count()

graves_death_distinct <- graves_death %>%
  distinct()


graves_death_count_distinct <- graves_death_distinct %>%
  group_by(g_year_death) %>%
  count()

graves_death_distinct <- graves_death_distinct %>%
  filter(g_year_death %in% c(100:2018)) 

ggplot(graves_death_distinct, aes(g_year_death)) +
  geom_bar()
```



```{r}
graves_death_distinct %>% na.omit(graves_death_distinct) %>%
  filter(g_date_death != "1900-01-01") %>%
  ggplot(aes(g_year_death)) +
  geom_bar() +
  xlim(1850,2018)
```


```{r}
# pojedyncze roczniki

graves_death_distinct %>% na.omit(graves_death_distinct) %>%
  filter(g_date_death != "1900-01-01") %>%
  ggplot(aes(g_year_death)) +
  geom_histogram(binwidth = 1) +
  xlim(1900,2018)
```



```{r}
graves_burial <- graves %>% 
  filter(g_date_burial != "0001-01-01", 1) %>% 
  mutate(g_date_burial=ymd(g_date_burial),
         g_year_burial=year(g_date_burial))

graves_burial_count <- graves_burial %>% 
  group_by(g_date_burial) %>% 
  count()

graves_burial_distinct <- graves_burial %>%
  distinct()

graves_burial_count_distinct <- graves_burial_distinct %>%
  group_by(g_year_burial) %>%
  count()

graves_burial_distinct <- graves_burial_distinct %>%
  filter(g_year_burial %in% c(1100:2018)) 

ggplot(graves_burial_distinct, aes(g_date_burial)) +
  ylim(0,100)+
  geom_bar()
```


```{r}
graves_burial_distinct %>% na.omit(graves_burial_distinct) %>%
  filter(g_date_burial != c("1900-01-01","1945-01-01")) %>%
  ggplot(aes(g_year_burial)) +
  geom_bar() +
  xlim(1850,2018)
```

```{r}
graves_burial_distinct %>% na.omit(graves_burial_distinct) %>%
  filter(g_date_burial != "1900-01-01") %>%
  ggplot(aes(g_year_burial)) +
  geom_histogram(binwidth = 1) +
  xlim(1850,2018)
```



```{r}
ggplot(data = graves_birth_count_distinct, aes(x=g_year_birth,y=n), color = "red")+
  geom_col(data = graves_birth_count_distinct, aes(g_year_birth,y=n), color = "red")+
  geom_col(data = graves_death_count_distinct, aes(g_year_death,y=n), color = "blue")+
  geom_col(data = graves_burial_count_distinct, aes(g_year_burial,y=n), color = "green")+
  ylim(0,2000)+
  xlim(1750,2018)
```


```{r}
library(lubridate)
datatime <- data2 %>% mutate(year = year(g_date_death)) %>% 
  ggplot(aes(x = year, y = n)) +
  geom_col()+
  xlim(1910,1921)
datatime2 <- data2 %>% mutate(year = year(g_date_death)) %>% 
  ggplot(aes(x = year, y = n)) +
  geom_col()+
  xlim(1920,1931)
datatime3 <- data2 %>% mutate(year = year(g_date_death)) %>% 
  ggplot(aes(x = year, y = n)) +
  geom_col()+
  xlim(1930,1941)
datatime
datatime2
datatime3




```


na przestrzeni 5 lat dla cm nr 24
```{r}
library(sqldf)
choice_cm_24 <- sqldf("select * from graves where g_date_death between 2000-01-01 and 2010-01-01") %>% 
  select(c(g_date_death,cm_id))

clean_cm_24 <- choice_cm_24 %>% 
  count(g_date_death,cm_id) %>% 
  slice(2:3464) %>% 
  filter(cm_id == 24) %>%
  arrange(n) %>% 
  slice(1:417) %>% arrange(g_date_death)

plot_ly(data = clean_cm_24, x = ~g_date_death, y = ~n, type = "scatter", mode = "markers")

plot(clean_cm_24$n, main = "zgony")

boxplot(clean_cm_24$n)

mean_24 <- mean(clean_cm_24$n)
stat_24 <- t(summary(clean_cm_24$n))
sd_24 <- sd(clean_cm_24$n)
sd_24
var_24 <- var(clean_cm_24$n)
var_24

statystic_24 <- cbind(sd_24,var_24,stat_24)
statystic_24

acf(clean_cm_24$n)
pacf(clean_cm_24$n)
frequency(clean_cm_24$n)
library(forecast)
graves.prediction_24 <- ets(clean_cm_24$n)
graves.prediction.forecast_24 <- forecast(graves.prediction_24)
plot(graves.prediction_24)
plot(graves.prediction.forecast_24)


log <- (log(clean_cm_24$n))
plot(log)
plot(clean_cm_24$n)


```

 na przestrzeni 5 lat dla cm nr 6 
```{r}
choice_cm_6 <- sqldf("select * from graves where g_date_death between 2000-01-01 and 2010-01-01") %>% 
  select(c(g_date_death,cm_id))

clean_cm_6 <- choice_cm_6 %>% 
  count(g_date_death,cm_id) %>% 
  filter(cm_id == 6) %>% 
  arrange(n) %>% 
  slice(1:2282) %>% arrange(g_date_death) %>% slice(1:791)

plot_ly(data = clean_cm_6, x = ~g_date_death, y = ~n, type = "scatter", mode = "markers")

plot(clean_cm_6$n, main = "zgony")

boxplot(clean_cm_6$n)

mean_6 <- mean(clean_cm_6$n)
stat_6 <- t(summary(clean_cm_6$n))
sd_6 <- sd(clean_cm_6$n)
sd_6
var_6 <- var(clean_cm_6$n)
var_6

statystic_6 <- cbind(sd_6,var_6,stat_6)
statystic_6

acf(clean_cm_6$n)
pacf(clean_cm_6$n)
frequency(clean_cm_6$n)
library(forecast)
graves.prediction_6 <- ets(clean_cm_6$n)
graves.prediction.forecast_6 <- forecast(graves.prediction_6)
plot(graves.prediction_6)
plot(graves.prediction.forecast_6)


log_6 <- (log(clean_cm_6$n))
plot(log)
plot(clean_cm_6$n)
```



