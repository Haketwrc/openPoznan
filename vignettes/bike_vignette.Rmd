---
title: "vignette_for_bikes"
author: "Kamil Nowak"
date: "10 sierpnia 2018"
output: html_document
---

```{r setup, include=FALSE}
  library(openPoznan)
  library(jsonlite)
  library(purrr)
  library(plyr)
  library(dplyr)
  library(ggplot2)
  library(ggmap)
  library(leaflet)
  library(sp)
  library(rgeos)
  library(geosphere)
  library(gmapsdistance)
  library(XML)
  library(sqldf)
  library(lubridate)
```

## Vignette for get_bike_place function.

```{r}
bike_place_example <- get_bike_place()
head(bike_place_example)
```

# Create map using gg plot, and put points on Poznan map.

```{r}
get_poznan <- get_map(c(16.916, 52.42), zoom = 12)
poznan <- ggmap(get_poznan)

poznan + geom_point(data=bike_place_example, aes(x=longitude, y=latitude))  +
  ylab("") + xlab("")
```
#Calculates the shortest distance between stations

```{r}

bike_place_example <- bike_place_example %>%
  mutate(id=1:nrow(bike_place_example))

bike_station_sp <- bike_place_example
coordinates(bike_station_sp) <- ~longitude + latitude

dist <- distm(bike_station_sp)
min_dist <- apply(dist, 1, function(x) order(x, decreasing=F)[2])

bike_station_dist <- cbind(bike_place_example, bike_place_example[min_dist,], 
                       apply(dist, 1, function(x) sort(x, decreasing=F)[2]))
colnames(bike_station_dist) <- c(colnames(bike_place_example), 
                             paste0("n_", colnames(bike_place_example)), "straight_distance")
bike_station_dist_2 <- sqldf("select * from bike_station_dist order by straight_distance")
head(bike_station_dist_2)


```
## Vignette for get_nextbike function.

```{r}
get_nextbike_example <- get_nextbike()
head(get_nextbike_example)
```
## Vignette for get_next_bike_data function.

```{r}
get_next_bike_data_example <- get_next_bike_data("10-08-2018 14:50","10-08-2018 15:10")
head(get_next_bike_data_example)
```

```{r}
data_table_final %>%
  filter(id=="6151") %>%
  group_by(date) %>%
  count() %>%
  ggplot(aes(x=n)) + geom_histogram(binwidth = 1)
```
# Number of bikes
```{r}

 data_table_final%>%
  distinct(number)%>%
  count()
```

# Number of bike stations
```{r}
 data_table_final%>%
  distinct(id)%>%
  count()
```


# Number of bike type
```{r}
 data_table_final%>%
  group_by(bike_type)%>%
  distinct(number)%>%
  count()
```
# Number of rented bikes
```{r}
example  <- data_table_final %>%
  group_by(date) %>%
  count() %>%
  mutate(n_rent=1066-n)

example

```


#Mediana
```{r}
median(example$n_rent)
```

```{r}

ggplot(data = example, aes(n_rent)) + geom_histogram(binwidth = 10)


```


#Mediana wypożyczeń rowerów z kazdej godziny



```{r}
median <- example %>%
    mutate(timePeriod = floor_date(dmy_hm(date), "30minutes")) %>%
  group_by(timePeriod) %>%
  summarise(mean=median(n_rent))


median
```
#The most rented bikes
```{r}
arrange(median,desc(mean))

```

#Suma wypożyczeń rowerów z kazdej godziny

```{r}
example %>%
    mutate(timePeriod = floor_date(dmy_hm(date), "30minutes")) %>%
  group_by(timePeriod) %>%
  summarise(sum=sum(n_rent)) %>%
  ggplot(aes(x=timePeriod, y=sum)) + geom_line() 

```

# Zmiana średniej ilości rowerów na stacji o id 6151
```{r}
data_table_final %>%
  filter(id=="6151")%>%
  group_by(date) %>%
  count() %>%
   mutate(timePeriod = floor_date(dmy_hm(date), "30minutes")) %>%
  group_by(timePeriod)%>%
    summarise(mean=median(n)) %>%
  ggplot(aes(x=timePeriod, y=mean)) + geom_line() 




```




